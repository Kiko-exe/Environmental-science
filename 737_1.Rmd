---
title: "ENVSCI_737_1"
author: "Yuehan Luo"
date: "2025-05-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# åŠ è½½å¿…è¦çš„åº“
library(ggplot2)
library(reshape2)

# è¯»å–æ•°æ®
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)

# è®¾ç½®ç¬¬ä¸€åˆ—ä¸ºç«™ç‚¹æ ‡ç­¾
df_data$Site <- as.character(df_data[, 1])

# æ ‡è®° EPT ç±»ç¾¤ï¼ˆ"E"ã€"P"ã€"T" è§†ä¸º EPTï¼‰
df_codes$is_EPT <- df_codes$EPT.taxa %in% c("E", "P", "T")

# æå–å­˜åœ¨äºæ•°æ®ä¸­çš„ä»£ç åˆ—
species_columns <- intersect(df_codes$Code, colnames(df_data))

# è®¡ç®—æ€»ä¸°å¯Œåº¦
df_richness <- df_data[, species_columns]
df_richness[df_richness > 0] <- 1
df_data$Taxa_Richness <- rowSums(df_richness)

# è®¡ç®— EPT ä¸°å¯Œåº¦
ept_codes <- df_codes$Code[df_codes$is_EPT]
ept_cols <- intersect(ept_codes, colnames(df_data))
df_ept_richness <- df_data[, ept_cols]
df_ept_richness[df_ept_richness > 0] <- 1
df_data$EPT_Richness <- rowSums(df_ept_richness)

# å‡†å¤‡ç»˜å›¾æ•°æ®
plot_df <- df_data[, c("Site", "Taxa_Richness", "EPT_Richness")]
plot_long <- melt(plot_df, id.vars = "Site",
                  variable.name = "Richness_Type",
                  value.name = "Richness_Count")

# ä¼˜åŒ–æ ‡ç­¾
plot_long$Richness_Type <- factor(plot_long$Richness_Type,
                                  levels = c("Taxa_Richness", "EPT_Richness"),
                                  labels = c("Taxa Richness", "EPT Taxa Richness"))

# ç»˜å›¾ï¼šæ‰‹åŠ¨è®¾ç½®é¢œè‰²ä¸ºè“ + æ©™
ggplot(plot_long, aes(x = Site, y = Richness_Count, fill = Richness_Type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  scale_fill_manual(values = c("Taxa Richness" = "#0072B2",  # è“
                               "EPT Taxa Richness" = "#E69F00")) + # æ©™
  labs(
    title = "Comparison of Total and EPT Taxa Richness by Site",
    subtitle = "Richness values reflect the number of taxa detected per site in the 1986 GBI survey",
    x = "Stream Site Code",
    y = "Number of Taxa (Richness)",
    fill = "Taxa Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, margin = margin(b = 10)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  )
```

```{r}
# ğŸ“¦ åŠ è½½å¿…è¦çš„åº“
library(vegan)
library(ggplot2)

# âœ… è¯»å–æ•°æ®
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)

# âœ… æå–ç«™ç‚¹ç¼–å·ï¼ˆåŸå§‹æ•°æ®ç¬¬ä¸€åˆ— Unnamed: 0ï¼‰
df_data$Site <- as.character(df_data[, 1])

# âœ… æå–ç‰©ç§ä»£ç åˆ—ï¼ˆdf_codes ä¸­åˆ—åä¸º 'Code'ï¼‰
valid_codes <- intersect(df_codes$Code, colnames(df_data))
community_matrix <- df_data[, valid_codes]

# âœ… è®¾ç½®è¡Œä¸ºç«™ç‚¹åï¼ˆSiteï¼‰
rownames(community_matrix) <- df_data$Site

# âœ… è¿è¡Œ NMDSï¼ˆä½¿ç”¨ Bray-Curtis è·ç¦»ï¼‰
nmds_result <- metaMDS(community_matrix, distance = "bray", k = 2, trymax = 100, autotransform = FALSE)

# âœ… æå–ç»“æœåæ ‡
nmds_points <- as.data.frame(nmds_result$points)
nmds_points$Site <- rownames(nmds_points)

# âœ… ç»˜å›¾ï¼ˆæ— åˆ†ç»„ï¼Œä»…æ˜¾ç¤ºç‚¹å’Œæ ‡ç­¾ï¼‰
ggplot(nmds_points, aes(x = MDS1, y = MDS2)) +
  geom_point(size = 3, color = "#0072B2") +
  geom_text(aes(label = Site), hjust = -0.2, vjust = -0.3, size = 3.2) +
  labs(
    title = "NMDS of Macroinvertebrate Communities (Unlabeled)",
    subtitle = paste0("Stress = ", round(nmds_result$stress, 4), " | Bray-Curtis Distance"),
    x = "NMDS Dimension 1",
    y = "NMDS Dimension 2"
  ) +
  theme_minimal(base_size = 12)
```

```{r}
library(ggplot2)
library(reshape2)
library(vegan)

# âœ… è¯»å–æ–‡ä»¶ï¼ˆæ³¨æ„ï¼šç¬¬ä¸€åˆ—ä¸º Site ç¼–å·ï¼‰
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)

# âœ… æå– Site ç¼–å·ï¼ˆä½¿ç”¨ç¬¬ä¸€åˆ—ï¼‰
df_data$Site <- as.character(df_data[, 1])  # ç¬¬ä¸€åˆ—ä¸º Site

# âœ… æ ‡è®° EPT ç±»ç¾¤
df_codes$is_EPT <- df_codes$EPT.taxa %in% c("E", "P", "T")

# âœ… è®¡ç®—ä¸°å¯Œåº¦ï¼šTaxa / EPT / Non-EPT
valid_codes <- intersect(df_codes$Code, colnames(df_data))
ept_codes <- intersect(df_codes$Code[df_codes$is_EPT], colnames(df_data))
non_ept_codes <- intersect(df_codes$Code[!df_codes$is_EPT], colnames(df_data))

df_data$Taxa_Richness <- rowSums(df_data[, valid_codes] > 0, na.rm = TRUE)
df_data$EPT_Richness <- rowSums(df_data[, ept_codes] > 0, na.rm = TRUE)
df_data$Non_EPT_Richness <- rowSums(df_data[, non_ept_codes] > 0, na.rm = TRUE)
df_data$Total_Richness <- df_data$EPT_Richness + df_data$Non_EPT_Richness
df_data$EPT_Percent <- (df_data$EPT_Richness / df_data$Total_Richness) * 100
df_data$EPT_to_Non_EPT_Ratio <- df_data$EPT_Richness / (df_data$Non_EPT_Richness + 1e-6)

# âœ… æ·»åŠ ä½ æä¾›çš„åˆ†ç»„ä¿¡æ¯
site_group <- data.frame(
  Site = c("17", "19", "20", "21", "24a", "24b", "25", "26", "27", "29", "30a", "30b", "30c", "31b", "31c", "32", "33", "34", "35", "40", "41", "42", "44"),
  Group = c("High Producing Exotic Grassland", "Broadleaved Indigenous Hardwoods", "Mangrove", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest", "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest", "Indigenous Forest", "Manuka and/or Kanuka")
)

df_data <- merge(df_data, site_group, by = "Site", all.x = TRUE)

# âœ… Figure 3â€“7: é€šç”¨ç®±çº¿å›¾å‡½æ•°
plot_box <- function(yvar, title, ylab) {
  ggplot(df_data[!is.na(df_data$Group), ], aes(x = Group, y = .data[[yvar]])) +
    geom_boxplot(fill = "#E69F00", color = "black") +
    labs(title = title, x = "Land Cover Type", y = ylab) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

# Figure 3: EPT Richness
plot_box("EPT_Richness", "EPT Richness by Land Cover Type", "EPT Richness")

# Figure 4: % EPT
plot_box("EPT_Percent", "% EPT Richness by Land Cover Type", "% EPT Richness")

# Figure 5: Non-EPT Richness
plot_box("Non_EPT_Richness", "Non-EPT Richness by Land Cover Type", "Non-EPT Richness")

# Figure 6: Ratio
plot_box("EPT_to_Non_EPT_Ratio", "EPT/Non-EPT Ratio by Land Cover Type", "EPT / Non-EPT Ratio")

# Figure 7: Total Richness
plot_box("Total_Richness", "Total Richness by Land Cover Type", "Total Richness")

# âœ… Figure 8: æ•£ç‚¹å›¾ EPT vs Non-EPT
ggplot(df_data[!is.na(df_data$Group), ], aes(x = Non_EPT_Richness, y = EPT_Richness, color = Group)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "black") +
  labs(
    title = "Scatterplot of EPT vs Non-EPT Richness",
    x = "Non-EPT Richness",
    y = "EPT Richness"
  ) +
  theme_minimal()

# âœ… Figure 9: E/P/T ä¸°å¯Œåº¦åˆ†ç»„ç®±çº¿å›¾
df_data$E_Richness <- rowSums(df_data[, intersect(df_codes$Code[df_codes$EPT.taxa == "E"], names(df_data))] > 0, na.rm = TRUE)
df_data$P_Richness <- rowSums(df_data[, intersect(df_codes$Code[df_codes$EPT.taxa == "P"], names(df_data))] > 0, na.rm = TRUE)
df_data$T_Richness <- rowSums(df_data[, intersect(df_codes$Code[df_codes$EPT.taxa == "T"], names(df_data))] > 0, na.rm = TRUE)

df_long <- melt(df_data[, c("Group", "E_Richness", "P_Richness", "T_Richness")], id.vars = "Group")

ggplot(df_long[!is.na(df_long$Group), ], aes(x = Group, y = value, fill = variable)) +
  geom_boxplot(position = "dodge") +
  scale_fill_manual(values = c("E_Richness" = "#E69F00", "P_Richness" = "#56B4E9", "T_Richness" = "#009E73"),
                    labels = c("Ephemeroptera", "Plecoptera", "Trichoptera")) +
  labs(
    title = "EPT Orders Richness by Land Cover Type",
    x = "Land Cover Type",
    y = "Richness (Number of Taxa)",
    fill = "EPT Order"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r}
library(ggplot2)
library(vegan)

# æå– NMDS åæ ‡ + å…ƒæ•°æ®
nmds_points <- as.data.frame(nmds_result$points)
nmds_points$Site <- df_data$Site
nmds_points$Group <- df_data$Group

# ç­›æ‰æœªåˆ†ç»„æ•°æ®
nmds_points <- nmds_points[!is.na(nmds_points$Group), ]

# âœ… ç»˜å›¾ï¼šæ”¾å¤§å®½åº¦ã€æ ‡ç­¾ç½®åº•ã€ç»Ÿä¸€é£æ ¼
ggplot(nmds_points, aes(x = MDS1, y = MDS2, color = Group)) +
  geom_point(size = 4, alpha = 0.9) +
  geom_text(aes(label = Site), vjust = 1.5, size = 3, color = "black") +
  labs(
    title = "nMDS ordination of Macroinvertebrate Communities",
    x = "nMDS Axis 1",
    y = "nMDS Axis 2",
    color = "Land Cover Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0.5, margin = margin(b = 10)),
    legend.position = "right",
    legend.title = element_text(size = 10),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 13)
  )

```
```{r}
# ğŸ“¦ åŠ è½½å¿…è¦åŒ…
# 
# install.packages("ggplot2")
library(ggplot2)
library(reshape2)
# 1. åŠ è½½æ•°æ®ï¼ˆè¯·æ›¿æ¢æˆä½ çš„è·¯å¾„ï¼‰
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)

# 2. åˆ›å»º Site å­—æ®µ
df_data$Site <- as.character(df_data[, 1])

# 3. æ ‡è®° E/P/T/Non-EPT ç±»ç¾¤
df_codes$EPT_group <- toupper(df_codes$EPT.taxa)
df_codes$EPT_group[df_codes$EPT_group %in% c("E", "P", "T")] <- 
  c("Ephemeroptera", "Plecoptera", "Trichoptera")[match(df_codes$EPT_group, c("E", "P", "T"))]
df_codes$EPT_group[!df_codes$EPT_group %in% c("Ephemeroptera", "Plecoptera", "Trichoptera")] <- "Non_EPT"

# 4. æœ‰æ•ˆç‰©ç§ä»£ç 
valid_codes <- intersect(df_codes$Code, colnames(df_data))

# 5. åˆ›å»º presence/absence æ•°æ®
presence_absence <- df_data[, valid_codes]
presence_absence[presence_absence > 0] <- 1
presence_absence$Site <- df_data$Site

# 6. æ˜ å°„ Code â†’ Group
group_map <- setNames(df_codes$EPT_group, df_codes$Code)

# 7. æ±‡æ€»æ¯ç±»ä¸°å¯Œåº¦
richness_by_order <- data.frame(
  Site = presence_absence$Site,
  Ephemeroptera = rowSums(presence_absence[, names(group_map[group_map == "Ephemeroptera"]), drop = FALSE]),
  Plecoptera = rowSums(presence_absence[, names(group_map[group_map == "Plecoptera"]), drop = FALSE]),
  Trichoptera = rowSums(presence_absence[, names(group_map[group_map == "Trichoptera"]), drop = FALSE]),
  Non_EPT = rowSums(presence_absence[, names(group_map[group_map == "Non_EPT"]), drop = FALSE])
)

# âœ… å‡è®¾ df æ˜¯åˆšæ‰ç”Ÿæˆçš„ `richness_by_order` æ•°æ®æ¡†
# å°†æ•°æ®è½¬æ¢æˆé•¿æ ¼å¼ï¼Œé€‚åˆåšå †å æ¡å½¢å›¾
df_long <- melt(richness_by_order[, c("Site", "Ephemeroptera", "Plecoptera", "Trichoptera", "Non_EPT")],
                id.vars = "Site",
                variable.name = "Group",
                value.name = "Taxa_Count")

# âœ… æ’åºç«™ç‚¹ä»¥å¢å¼ºè§†è§‰é¡ºåºæ„Ÿ
df_long$Site <- factor(df_long$Site, levels = unique(df_long$Site))

# âœ… ç»˜åˆ¶å †å æ¡å½¢å›¾
ggplot(df_long, aes(x = Site, y = Taxa_Count, fill = Group)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Ephemeroptera" = "#E69F00",
                               "Plecoptera" = "#0072B2",
                               "Trichoptera" = "#009E73",
                               "Non_EPT" = "#999999")) +
  labs(
    title = "Taxonomic Composition of Macroinvertebrates by Site",
    subtitle = "Stacked barplot of Ephemeroptera, Plecoptera, Trichoptera, and Non-EPT groups",
    x = "Stream Site",
    y = "Number of Taxa",
    fill = "Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```
```{r}
# ğŸ“¦ å¦‚æœä½ å°šæœªå®‰è£… heatmap åŒ…ï¼Œå¯ä»¥ä½¿ç”¨ pheatmap
# install.packages("pheatmap")
library(pheatmap)

# âœ… å‡è®¾ richness_by_order å·²ç”Ÿæˆï¼ˆåŒ…å« Site + Ephemeroptera + Plecoptera + Trichopteraï¼‰
# é€‰å–åªç”» E/P/T ä¸‰ç±»
heat_matrix <- richness_by_order[, c("Ephemeroptera", "Plecoptera", "Trichoptera")]
rownames(heat_matrix) <- richness_by_order$Site

# âœ… ç»˜åˆ¶çƒ­å›¾ï¼ˆæ ‡å‡†åŒ–æ¯åˆ—ä½¿é¢œè‰²å¯¹æ¯”æ›´æ˜æ˜¾ï¼‰
pheatmap(
  mat = heat_matrix,
  scale = "column",  # æ ‡å‡†åŒ–æ¯åˆ—ä»¥æ¯”è¾ƒç›¸å¯¹å€¼
  clustering_distance_rows = "euclidean",
  clustering_method = "complete",
  color = colorRampPalette(c("white", "#56B4E9", "#0072B2"))(100),
  main = "Figure B - E/P/T Taxa Richness Heatmap by Site",
  fontsize_row = 10,
  fontsize_col = 11
)
```

```{r}
# å®‰è£…ä¸€æ¬¡å³å¯
# install.packages("ggtern")
library(ggtern)

# å‡è®¾ richness_by_order å·²ç”Ÿæˆ

# åªä¿ç•™ E, P, T åˆ—ï¼Œå¹¶æ ‡å‡†åŒ–ä¸ºæ¯”ä¾‹ï¼ˆå’Œä¸º 1ï¼‰
df_tern <- richness_by_order[, c("Site", "Ephemeroptera", "Plecoptera", "Trichoptera")]
df_tern$total <- rowSums(df_tern[, 2:4])
df_tern$E <- df_tern$Ephemeroptera / df_tern$total
df_tern$P <- df_tern$Plecoptera / df_tern$total
df_tern$T <- df_tern$Trichoptera / df_tern$total

ggtern(data = df_tern, aes(x = E, y = P, z = T, label = Site)) +
  geom_point(color = "#0072B2", size = 3, alpha = 0.8) +
  geom_text(size = 3, vjust = -0.5, color = "black") +
  labs(
    title = "Ternary Plot of E/P/T Composition",
    T = "Trichoptera",
    L = "Ephemeroptera",
    R = "Plecoptera"
  ) +
  theme_bw(base_size = 13) +
  theme_showarrows()
```

```{r}
# ğŸ“¦ åŠ è½½å¿…è¦åŒ…
# install.packages("ggplot2")
library(ggplot2)

# âœ… 1. å¯¼å…¥æ•°æ®
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)

# âœ… 2. åˆ›å»º Site å­—æ®µ
df_data$Site <- as.character(df_data[, 1])

# âœ… 3. æ·»åŠ  EPT ç±»åˆ«
df_codes$EPT_group <- toupper(df_codes$EPT.taxa)
df_codes$EPT_group[df_codes$EPT_group %in% c("E", "P", "T")] <- 
  c("Ephemeroptera", "Plecoptera", "Trichoptera")[match(df_codes$EPT_group, c("E", "P", "T"))]
df_codes$EPT_group[!df_codes$EPT_group %in% c("Ephemeroptera", "Plecoptera", "Trichoptera")] <- "Non_EPT"

# âœ… 4. æå–æœ‰æ•ˆç‰©ç§ä»£ç åˆ—
valid_codes <- intersect(df_codes$Code, colnames(df_data))

# âœ… 5. æ„å»º presence/absence çŸ©é˜µ
presence_absence <- df_data[, valid_codes]
presence_absence[presence_absence > 0] <- 1
presence_absence$Site <- df_data$Site

# âœ… 6. ç‰©ç§ä»£ç  â†’ åˆ†ç±»æ˜ å°„
group_map <- setNames(df_codes$EPT_group, df_codes$Code)

# âœ… 7. æ¯ç±»ç¾¤è®¡æ•°
richness_by_order <- data.frame(
  Site = presence_absence$Site,
  Ephemeroptera = rowSums(presence_absence[, names(group_map[group_map == "Ephemeroptera"]), drop = FALSE]),
  Plecoptera    = rowSums(presence_absence[, names(group_map[group_map == "Plecoptera"]), drop = FALSE]),
  Trichoptera   = rowSums(presence_absence[, names(group_map[group_map == "Trichoptera"]), drop = FALSE]),
  Non_EPT       = rowSums(presence_absence[, names(group_map[group_map == "Non_EPT"]), drop = FALSE])
)
richness_by_order$Total_Taxa <- rowSums(richness_by_order[, c("Ephemeroptera", "Plecoptera", "Trichoptera", "Non_EPT")])

# âœ… 8. æ·»åŠ åˆ†ç»„ä¿¡æ¯ï¼ˆä½ è‡ªå·±æ‰‹å·¥åˆ†çš„ï¼‰
site_group <- data.frame(
  Site = c("17", "19", "20", "21", "24a", "24b", "25", "26", "27", "29", "30a", "30b", "30c",
           "31b", "31c", "32", "33", "34", "35", "40", "41", "42", "44"),
  Group = c("High Producing Exotic Grassland", "Broadleaved Indigenous Hardwoods", "Mangrove", "Manuka and/or Kanuka",
            "Manuka and/or Kanuka", "Manuka and/or Kanuka", "High Producing Exotic Grassland", "Manuka and/or Kanuka",
            "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka",
            "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest",
            "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest",
            "Exotic Forest", "Indigenous Forest", "Manuka and/or Kanuka")
)

# âœ… 9. åˆå¹¶ Group åˆ° richness æ•°æ®
df_grouped <- merge(richness_by_order, site_group, by = "Site", all.x = TRUE)

# âœ… 10. è®¡ç®— Non-EPT ç™¾åˆ†æ¯”
df_grouped$Non_EPT_Percent <- (df_grouped$Non_EPT / df_grouped$Total_Taxa) * 100

# âœ… 11. ç»˜å›¾ï¼šNon-EPT ç™¾åˆ†æ¯”ç®±çº¿å›¾
ggplot(df_grouped[!is.na(df_grouped$Group), ], aes(x = Group, y = Non_EPT_Percent)) +
  geom_boxplot(fill = "#999999", color = "black") +
  labs(
    title = "Figure D - Proportion of Non-EPT Taxa by Land Cover Type",
    x = "Land Cover Type",
    y = "Non-EPT Proportion (%)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)

rownames(df_data) <- df_data$X
df_data <- df_data[, -1]  # å»æ‰Xåˆ—

site_group <- data.frame(
  Site = c("17", "19", "20", "21", "24a", "24b", "25", "26", "27", "29", "30a", "30b", "30c", "31b", "31c", "32", "33", "34", "35", "40", "41", "42", "44"),
  Group = c("High Producing Exotic Grassland", "Broadleaved Indigenous Hardwoods", "Mangrove", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest", "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest", "Indigenous Forest", "Manuka and/or Kanuka")
)

# ç¡®ä¿ rownames å’Œ site_group ä¸­ Site æ˜¯å¯¹åº”çš„
rownames(df_data) <- gsub("sample_", "", rownames(df_data))  # å¦‚æœ‰â€œsample_â€ï¼Œå¯å»æ‰
df_data <- df_data[site_group$Site, ]  # é‡æ–°æ’åº

library(vegan)
library(dendextend)

bc_dist <- vegdist(df_data, method = "bray")
hc <- hclust(bc_dist, method = "average")  # UPGMA
dend <- as.dendrogram(hc)
group_colors <- c(
  "High Producing Exotic Grassland" = "red",
  "Broadleaved Indigenous Hardwoods" = "blue",
  "Mangrove" = "green",
  "Manuka and/or Kanuka" = "orange",
  "Indigenous Forest" = "purple",
  "Exotic Forest" = "brown"
)

colLab <- function(n) {
  if (is.leaf(n)) {
    label <- attr(n, "label")
    group <- site_group$Group[match(label, site_group$Site)]
    col <- group_colors[group]
    attr(n, "nodePar") <- c(attr(n, "nodePar"), list(lab.col = col, col = col, pch = 19, cex = 1.2))
  }
  return(n)
}

dend_colored <- dendrapply(dend, colLab)

plot(dend_colored, main = "Bray-Curtis + UPGMA clustering by Cover Land Type")
legend("topright",
       legend = names(group_colors),
       col = group_colors,
       pch = 19,
       bty = "n", cex = 0.8)
```

```{r}
# ğŸ§© åˆå¹¶ site_group åˆ†ç»„ä¿¡æ¯
community_matrix$Site <- rownames(community_matrix)
community_with_group <- merge(community_matrix, site_group, by = "Site")

# âœ… åˆ†å¼€ç¾¤è½çŸ©é˜µå’Œåˆ†ç»„å˜é‡
grouped_matrix <- community_with_group[, valid_codes]  # åªä¿ç•™ç¾¤è½æ•°æ®åˆ—
land_cover <- community_with_group$Group                # æå– Group ä¿¡æ¯

# ğŸ” è¿è¡Œ PERMANOVA
permanova_result <- adonis2(grouped_matrix ~ land_cover, method = "bray")
print(permanova_result)


```