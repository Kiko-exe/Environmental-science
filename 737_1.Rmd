---
title: "ENVSCI_737_1"
author: "Yuehan Luo"
date: "2025-05-14"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# 加载必要的库
library(ggplot2)
library(reshape2)

# 读取数据
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)

# 设置第一列为站点标签
df_data$Site <- as.character(df_data[, 1])

# 标记 EPT 类群（"E"、"P"、"T" 视为 EPT）
df_codes$is_EPT <- df_codes$EPT.taxa %in% c("E", "P", "T")

# 提取存在于数据中的代码列
species_columns <- intersect(df_codes$Code, colnames(df_data))

# 计算总丰富度
df_richness <- df_data[, species_columns]
df_richness[df_richness > 0] <- 1
df_data$Taxa_Richness <- rowSums(df_richness)

# 计算 EPT 丰富度
ept_codes <- df_codes$Code[df_codes$is_EPT]
ept_cols <- intersect(ept_codes, colnames(df_data))
df_ept_richness <- df_data[, ept_cols]
df_ept_richness[df_ept_richness > 0] <- 1
df_data$EPT_Richness <- rowSums(df_ept_richness)

# 准备绘图数据
plot_df <- df_data[, c("Site", "Taxa_Richness", "EPT_Richness")]
plot_long <- melt(plot_df, id.vars = "Site",
                  variable.name = "Richness_Type",
                  value.name = "Richness_Count")

# 优化标签
plot_long$Richness_Type <- factor(plot_long$Richness_Type,
                                  levels = c("Taxa_Richness", "EPT_Richness"),
                                  labels = c("Taxa Richness", "EPT Taxa Richness"))

# 绘图：手动设置颜色为蓝 + 橙
ggplot(plot_long, aes(x = Site, y = Richness_Count, fill = Richness_Type)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8), width = 0.7) +
  scale_fill_manual(values = c("Taxa Richness" = "#0072B2",  # 蓝
                               "EPT Taxa Richness" = "#E69F00")) + # 橙
  labs(
    title = "Comparison of Total and EPT Taxa Richness by Site",
    subtitle = "Richness values reflect the number of taxa detected per site in the 1986 GBI survey",
    x = "Stream Site Code",
    y = "Number of Taxa (Richness)",
    fill = "Taxa Group"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 11, hjust = 0.5, margin = margin(b = 10)),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "top"
  )
```

```{r}
# 📦 加载必要的库
library(vegan)
library(ggplot2)

# ✅ 读取数据
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)

# ✅ 提取站点编号（原始数据第一列 Unnamed: 0）
df_data$Site <- as.character(df_data[, 1])

# ✅ 提取物种代码列（df_codes 中列名为 'Code'）
valid_codes <- intersect(df_codes$Code, colnames(df_data))
community_matrix <- df_data[, valid_codes]

# ✅ 设置行为站点名（Site）
rownames(community_matrix) <- df_data$Site

# ✅ 运行 NMDS（使用 Bray-Curtis 距离）
nmds_result <- metaMDS(community_matrix, distance = "bray", k = 2, trymax = 100, autotransform = FALSE)

# ✅ 提取结果坐标
nmds_points <- as.data.frame(nmds_result$points)
nmds_points$Site <- rownames(nmds_points)

# ✅ 绘图（无分组，仅显示点和标签）
ggplot(nmds_points, aes(x = MDS1, y = MDS2)) +
  geom_point(size = 3, color = "#0072B2") +
  geom_text(aes(label = Site), hjust = -0.2, vjust = -0.3, size = 3.2) +
  labs(
    title = "NMDS of Macroinvertebrate Communities (Unlabeled)",
    subtitle = paste0("Stress = ", round(nmds_result$stress, 4), " | Bray-Curtis Distance"),
    x = "NMDS Dimension 1",
    y = "NMDS Dimension 2"
  ) +
  theme_minimal(base_size = 12)
```

```{r}
library(ggplot2)
library(reshape2)
library(vegan)

# ✅ 读取文件（注意：第一列为 Site 编号）
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)

# ✅ 提取 Site 编号（使用第一列）
df_data$Site <- as.character(df_data[, 1])  # 第一列为 Site

# ✅ 标记 EPT 类群
df_codes$is_EPT <- df_codes$EPT.taxa %in% c("E", "P", "T")

# ✅ 计算丰富度：Taxa / EPT / Non-EPT
valid_codes <- intersect(df_codes$Code, colnames(df_data))
ept_codes <- intersect(df_codes$Code[df_codes$is_EPT], colnames(df_data))
non_ept_codes <- intersect(df_codes$Code[!df_codes$is_EPT], colnames(df_data))

df_data$Taxa_Richness <- rowSums(df_data[, valid_codes] > 0, na.rm = TRUE)
df_data$EPT_Richness <- rowSums(df_data[, ept_codes] > 0, na.rm = TRUE)
df_data$Non_EPT_Richness <- rowSums(df_data[, non_ept_codes] > 0, na.rm = TRUE)
df_data$Total_Richness <- df_data$EPT_Richness + df_data$Non_EPT_Richness
df_data$EPT_Percent <- (df_data$EPT_Richness / df_data$Total_Richness) * 100
df_data$EPT_to_Non_EPT_Ratio <- df_data$EPT_Richness / (df_data$Non_EPT_Richness + 1e-6)

# ✅ 添加你提供的分组信息
site_group <- data.frame(
  Site = c("17", "19", "20", "21", "24a", "24b", "25", "26", "27", "29", "30a", "30b", "30c", "31b", "31c", "32", "33", "34", "35", "40", "41", "42", "44"),
  Group = c("High Producing Exotic Grassland", "Broadleaved Indigenous Hardwoods", "Mangrove", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest", "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest", "Indigenous Forest", "Manuka and/or Kanuka")
)

df_data <- merge(df_data, site_group, by = "Site", all.x = TRUE)

# ✅ Figure 3–7: 通用箱线图函数
plot_box <- function(yvar, title, ylab) {
  ggplot(df_data[!is.na(df_data$Group), ], aes(x = Group, y = .data[[yvar]])) +
    geom_boxplot(fill = "#E69F00", color = "black") +
    labs(title = title, x = "Land Cover Type", y = ylab) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

# Figure 3: EPT Richness
plot_box("EPT_Richness", "EPT Richness by Land Cover Type", "EPT Richness")

# Figure 4: % EPT
plot_box("EPT_Percent", "% EPT Richness by Land Cover Type", "% EPT Richness")

# Figure 5: Non-EPT Richness
plot_box("Non_EPT_Richness", "Non-EPT Richness by Land Cover Type", "Non-EPT Richness")

# Figure 6: Ratio
plot_box("EPT_to_Non_EPT_Ratio", "EPT/Non-EPT Ratio by Land Cover Type", "EPT / Non-EPT Ratio")

# Figure 7: Total Richness
plot_box("Total_Richness", "Total Richness by Land Cover Type", "Total Richness")

# ✅ Figure 8: 散点图 EPT vs Non-EPT
ggplot(df_data[!is.na(df_data$Group), ], aes(x = Non_EPT_Richness, y = EPT_Richness, color = Group)) +
  geom_point(size = 3, alpha = 0.8) +
  geom_smooth(method = "lm", se = FALSE, linetype = "dashed", color = "black") +
  labs(
    title = "Scatterplot of EPT vs Non-EPT Richness",
    x = "Non-EPT Richness",
    y = "EPT Richness"
  ) +
  theme_minimal()

# ✅ Figure 9: E/P/T 丰富度分组箱线图
df_data$E_Richness <- rowSums(df_data[, intersect(df_codes$Code[df_codes$EPT.taxa == "E"], names(df_data))] > 0, na.rm = TRUE)
df_data$P_Richness <- rowSums(df_data[, intersect(df_codes$Code[df_codes$EPT.taxa == "P"], names(df_data))] > 0, na.rm = TRUE)
df_data$T_Richness <- rowSums(df_data[, intersect(df_codes$Code[df_codes$EPT.taxa == "T"], names(df_data))] > 0, na.rm = TRUE)

df_long <- melt(df_data[, c("Group", "E_Richness", "P_Richness", "T_Richness")], id.vars = "Group")

ggplot(df_long[!is.na(df_long$Group), ], aes(x = Group, y = value, fill = variable)) +
  geom_boxplot(position = "dodge") +
  scale_fill_manual(values = c("E_Richness" = "#E69F00", "P_Richness" = "#56B4E9", "T_Richness" = "#009E73"),
                    labels = c("Ephemeroptera", "Plecoptera", "Trichoptera")) +
  labs(
    title = "EPT Orders Richness by Land Cover Type",
    x = "Land Cover Type",
    y = "Richness (Number of Taxa)",
    fill = "EPT Order"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

```
```{r}
library(ggplot2)
library(vegan)

# 提取 NMDS 坐标 + 元数据
nmds_points <- as.data.frame(nmds_result$points)
nmds_points$Site <- df_data$Site
nmds_points$Group <- df_data$Group

# 筛掉未分组数据
nmds_points <- nmds_points[!is.na(nmds_points$Group), ]

# ✅ 绘图：放大宽度、标签置底、统一风格
ggplot(nmds_points, aes(x = MDS1, y = MDS2, color = Group)) +
  geom_point(size = 4, alpha = 0.9) +
  geom_text(aes(label = Site), vjust = 1.5, size = 3, color = "black") +
  labs(
    title = "nMDS ordination of Macroinvertebrate Communities",
    x = "nMDS Axis 1",
    y = "nMDS Axis 2",
    color = "Land Cover Type"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", size = 12, hjust = 0.5, margin = margin(b = 10)),
    legend.position = "right",
    legend.title = element_text(size = 10),
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 13)
  )

```
```{r}
# 📦 加载必要包
# 
# install.packages("ggplot2")
library(ggplot2)
library(reshape2)
# 1. 加载数据（请替换成你的路径）
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)

# 2. 创建 Site 字段
df_data$Site <- as.character(df_data[, 1])

# 3. 标记 E/P/T/Non-EPT 类群
df_codes$EPT_group <- toupper(df_codes$EPT.taxa)
df_codes$EPT_group[df_codes$EPT_group %in% c("E", "P", "T")] <- 
  c("Ephemeroptera", "Plecoptera", "Trichoptera")[match(df_codes$EPT_group, c("E", "P", "T"))]
df_codes$EPT_group[!df_codes$EPT_group %in% c("Ephemeroptera", "Plecoptera", "Trichoptera")] <- "Non_EPT"

# 4. 有效物种代码
valid_codes <- intersect(df_codes$Code, colnames(df_data))

# 5. 创建 presence/absence 数据
presence_absence <- df_data[, valid_codes]
presence_absence[presence_absence > 0] <- 1
presence_absence$Site <- df_data$Site

# 6. 映射 Code → Group
group_map <- setNames(df_codes$EPT_group, df_codes$Code)

# 7. 汇总每类丰富度
richness_by_order <- data.frame(
  Site = presence_absence$Site,
  Ephemeroptera = rowSums(presence_absence[, names(group_map[group_map == "Ephemeroptera"]), drop = FALSE]),
  Plecoptera = rowSums(presence_absence[, names(group_map[group_map == "Plecoptera"]), drop = FALSE]),
  Trichoptera = rowSums(presence_absence[, names(group_map[group_map == "Trichoptera"]), drop = FALSE]),
  Non_EPT = rowSums(presence_absence[, names(group_map[group_map == "Non_EPT"]), drop = FALSE])
)

# ✅ 假设 df 是刚才生成的 `richness_by_order` 数据框
# 将数据转换成长格式，适合做堆叠条形图
df_long <- melt(richness_by_order[, c("Site", "Ephemeroptera", "Plecoptera", "Trichoptera", "Non_EPT")],
                id.vars = "Site",
                variable.name = "Group",
                value.name = "Taxa_Count")

# ✅ 排序站点以增强视觉顺序感
df_long$Site <- factor(df_long$Site, levels = unique(df_long$Site))

# ✅ 绘制堆叠条形图
ggplot(df_long, aes(x = Site, y = Taxa_Count, fill = Group)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = c("Ephemeroptera" = "#E69F00",
                               "Plecoptera" = "#0072B2",
                               "Trichoptera" = "#009E73",
                               "Non_EPT" = "#999999")) +
  labs(
    title = "Taxonomic Composition of Macroinvertebrates by Site",
    subtitle = "Stacked barplot of Ephemeroptera, Plecoptera, Trichoptera, and Non-EPT groups",
    x = "Stream Site",
    y = "Number of Taxa",
    fill = "Group"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5)
  )
```
```{r}
# 📦 如果你尚未安装 heatmap 包，可以使用 pheatmap
# install.packages("pheatmap")
library(pheatmap)

# ✅ 假设 richness_by_order 已生成（包含 Site + Ephemeroptera + Plecoptera + Trichoptera）
# 选取只画 E/P/T 三类
heat_matrix <- richness_by_order[, c("Ephemeroptera", "Plecoptera", "Trichoptera")]
rownames(heat_matrix) <- richness_by_order$Site

# ✅ 绘制热图（标准化每列使颜色对比更明显）
pheatmap(
  mat = heat_matrix,
  scale = "column",  # 标准化每列以比较相对值
  clustering_distance_rows = "euclidean",
  clustering_method = "complete",
  color = colorRampPalette(c("white", "#56B4E9", "#0072B2"))(100),
  main = "Figure B - E/P/T Taxa Richness Heatmap by Site",
  fontsize_row = 10,
  fontsize_col = 11
)
```

```{r}
# 安装一次即可
# install.packages("ggtern")
library(ggtern)

# 假设 richness_by_order 已生成

# 只保留 E, P, T 列，并标准化为比例（和为 1）
df_tern <- richness_by_order[, c("Site", "Ephemeroptera", "Plecoptera", "Trichoptera")]
df_tern$total <- rowSums(df_tern[, 2:4])
df_tern$E <- df_tern$Ephemeroptera / df_tern$total
df_tern$P <- df_tern$Plecoptera / df_tern$total
df_tern$T <- df_tern$Trichoptera / df_tern$total

ggtern(data = df_tern, aes(x = E, y = P, z = T, label = Site)) +
  geom_point(color = "#0072B2", size = 3, alpha = 0.8) +
  geom_text(size = 3, vjust = -0.5, color = "black") +
  labs(
    title = "Ternary Plot of E/P/T Composition",
    T = "Trichoptera",
    L = "Ephemeroptera",
    R = "Plecoptera"
  ) +
  theme_bw(base_size = 13) +
  theme_showarrows()
```

```{r}
# 📦 加载必要包
# install.packages("ggplot2")
library(ggplot2)

# ✅ 1. 导入数据
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)
df_codes <- read.csv("GB taxa codes_EPT.csv", stringsAsFactors = FALSE)

# ✅ 2. 创建 Site 字段
df_data$Site <- as.character(df_data[, 1])

# ✅ 3. 添加 EPT 类别
df_codes$EPT_group <- toupper(df_codes$EPT.taxa)
df_codes$EPT_group[df_codes$EPT_group %in% c("E", "P", "T")] <- 
  c("Ephemeroptera", "Plecoptera", "Trichoptera")[match(df_codes$EPT_group, c("E", "P", "T"))]
df_codes$EPT_group[!df_codes$EPT_group %in% c("Ephemeroptera", "Plecoptera", "Trichoptera")] <- "Non_EPT"

# ✅ 4. 提取有效物种代码列
valid_codes <- intersect(df_codes$Code, colnames(df_data))

# ✅ 5. 构建 presence/absence 矩阵
presence_absence <- df_data[, valid_codes]
presence_absence[presence_absence > 0] <- 1
presence_absence$Site <- df_data$Site

# ✅ 6. 物种代码 → 分类映射
group_map <- setNames(df_codes$EPT_group, df_codes$Code)

# ✅ 7. 每类群计数
richness_by_order <- data.frame(
  Site = presence_absence$Site,
  Ephemeroptera = rowSums(presence_absence[, names(group_map[group_map == "Ephemeroptera"]), drop = FALSE]),
  Plecoptera    = rowSums(presence_absence[, names(group_map[group_map == "Plecoptera"]), drop = FALSE]),
  Trichoptera   = rowSums(presence_absence[, names(group_map[group_map == "Trichoptera"]), drop = FALSE]),
  Non_EPT       = rowSums(presence_absence[, names(group_map[group_map == "Non_EPT"]), drop = FALSE])
)
richness_by_order$Total_Taxa <- rowSums(richness_by_order[, c("Ephemeroptera", "Plecoptera", "Trichoptera", "Non_EPT")])

# ✅ 8. 添加分组信息（你自己手工分的）
site_group <- data.frame(
  Site = c("17", "19", "20", "21", "24a", "24b", "25", "26", "27", "29", "30a", "30b", "30c",
           "31b", "31c", "32", "33", "34", "35", "40", "41", "42", "44"),
  Group = c("High Producing Exotic Grassland", "Broadleaved Indigenous Hardwoods", "Mangrove", "Manuka and/or Kanuka",
            "Manuka and/or Kanuka", "Manuka and/or Kanuka", "High Producing Exotic Grassland", "Manuka and/or Kanuka",
            "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka",
            "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest",
            "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest",
            "Exotic Forest", "Indigenous Forest", "Manuka and/or Kanuka")
)

# ✅ 9. 合并 Group 到 richness 数据
df_grouped <- merge(richness_by_order, site_group, by = "Site", all.x = TRUE)

# ✅ 10. 计算 Non-EPT 百分比
df_grouped$Non_EPT_Percent <- (df_grouped$Non_EPT / df_grouped$Total_Taxa) * 100

# ✅ 11. 绘图：Non-EPT 百分比箱线图
ggplot(df_grouped[!is.na(df_grouped$Group), ], aes(x = Group, y = Non_EPT_Percent)) +
  geom_boxplot(fill = "#999999", color = "black") +
  labs(
    title = "Figure D - Proportion of Non-EPT Taxa by Land Cover Type",
    x = "Land Cover Type",
    y = "Non-EPT Proportion (%)"
  ) +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
df_data <- read.csv("GB_bugs_86_PAST_upscaled.csv", stringsAsFactors = FALSE)

rownames(df_data) <- df_data$X
df_data <- df_data[, -1]  # 去掉X列

site_group <- data.frame(
  Site = c("17", "19", "20", "21", "24a", "24b", "25", "26", "27", "29", "30a", "30b", "30c", "31b", "31c", "32", "33", "34", "35", "40", "41", "42", "44"),
  Group = c("High Producing Exotic Grassland", "Broadleaved Indigenous Hardwoods", "Mangrove", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest", "High Producing Exotic Grassland", "Manuka and/or Kanuka", "Manuka and/or Kanuka", "Indigenous Forest", "Exotic Forest", "Indigenous Forest", "Manuka and/or Kanuka")
)

# 确保 rownames 和 site_group 中 Site 是对应的
rownames(df_data) <- gsub("sample_", "", rownames(df_data))  # 如有“sample_”，可去掉
df_data <- df_data[site_group$Site, ]  # 重新排序

library(vegan)
library(dendextend)

bc_dist <- vegdist(df_data, method = "bray")
hc <- hclust(bc_dist, method = "average")  # UPGMA
dend <- as.dendrogram(hc)
group_colors <- c(
  "High Producing Exotic Grassland" = "red",
  "Broadleaved Indigenous Hardwoods" = "blue",
  "Mangrove" = "green",
  "Manuka and/or Kanuka" = "orange",
  "Indigenous Forest" = "purple",
  "Exotic Forest" = "brown"
)

colLab <- function(n) {
  if (is.leaf(n)) {
    label <- attr(n, "label")
    group <- site_group$Group[match(label, site_group$Site)]
    col <- group_colors[group]
    attr(n, "nodePar") <- c(attr(n, "nodePar"), list(lab.col = col, col = col, pch = 19, cex = 1.2))
  }
  return(n)
}

dend_colored <- dendrapply(dend, colLab)

plot(dend_colored, main = "Bray-Curtis + UPGMA clustering by Cover Land Type")
legend("topright",
       legend = names(group_colors),
       col = group_colors,
       pch = 19,
       bty = "n", cex = 0.8)
```

```{r}
# 🧩 合并 site_group 分组信息
community_matrix$Site <- rownames(community_matrix)
community_with_group <- merge(community_matrix, site_group, by = "Site")

# ✅ 分开群落矩阵和分组变量
grouped_matrix <- community_with_group[, valid_codes]  # 只保留群落数据列
land_cover <- community_with_group$Group                # 提取 Group 信息

# 🔍 运行 PERMANOVA
permanova_result <- adonis2(grouped_matrix ~ land_cover, method = "bray")
print(permanova_result)


```